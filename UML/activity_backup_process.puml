@startuml EasySave_Activity_Backup_Process
!theme plain

start

:User launches EasySave;

if (Command line arguments?) then (yes)
    :Parse job indexes from arguments;
    note right
        Supports formats:
        - Single: "1"
        - Range: "1-3"
        - List: "1;3;5"
    end note
else (no)
    :Show interactive menu;
    :User selects language (EN/FR);
    :Display main menu;
    :User selects "Run Job" option;
    :User enters job index/indexes;
endif

partition "For each job to execute" {
    :Retrieve BackupJob from JobManager;
    
    if (Job exists?) then (yes)
        :Create BackupService instance;
        
        partition "Execute Backup" {
            
            ' Pre-calculation phase
            :Calculate total files and size;
            note right
                Recursively count all files
                in source directory tree
            end note
            
            :Initialize progress counters;
            :filesProcessed = 0;
            :bytesProcessed = 0;
            
            ' Initialize state
            :Update state.json;
            note right
                State: ACTIVE
                Progression: 0%
            end note
            
            ' Processing phase
            partition "Process Directory (Recursive)" {
                :Get all files in current directory;
                
                repeat
                    :Pick next file;
                    
                    ' Calculate progress
                    :Calculate progression percentage;
                    :Update state.json with progress;
                    
                    ' Determine if file needs backup
                    if (Backup type?) then (Full)
                        :File needs backup;
                    else (Differential)
                        if (Target file exists AND source is newer?) then (yes)
                            :File needs backup;
                        else (no)
                            :Skip file (already up to date);
                        endif
                    endif
                    
                    if (File needs backup?) then (yes)
                        :Start timer;
                        :Read source file;
                        :Write to target file;
                        :Stop timer;
                        
                        ' Convert paths to UNC format
                        :Convert source path to UNC;
                        :Convert target path to UNC;
                        note right
                            C:\Folder -> \\localhost\C$\Folder
                        end note
                        
                        if (Copy successful?) then (yes)
                            :Write log entry;
                            note right
                                TransferTime > 0
                                ErrorMessage = null
                            end note
                        else (no - error)
                            :Write error log entry;
                            note right
                                TransferTime = -1
                                ErrorMessage set
                            end note
                        endif
                    endif
                    
                    :Update progress counters;
                    :filesProcessed++;
                    :bytesProcessed += fileSize;
                    
                repeat while (More files in directory?) is (yes)
                ->no;
                
                :Get all subdirectories;
                
                repeat
                    :Pick next subdirectory;
                    :Process subdirectory recursively;
                    note right
                        Same process for
                        each subdirectory
                    end note
                repeat while (More subdirectories?) is (yes)
                ->no;
            }
            
            ' Completion phase
            :Update state.json;
            note right
                State: END
                Progression: 100%
            end note
            
            :Display success message;
        }
        
    else (no)
        :Display error message;
        note right
            "Job not found"
        end note
    endif
}

if (More jobs to execute?) then (yes)
    :Continue to next job;
    detach
else (no)
    if (Interactive mode?) then (yes)
        :Wait for key press;
        :Return to main menu;
        detach
    else (no - CLI mode)
        stop
    endif
endif

@enduml
