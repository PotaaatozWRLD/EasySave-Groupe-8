@startuml EasySave_Sequence_Parallel_Backup_v3.0
!theme plain
autonumber

actor User
participant "MainViewModel" as VM
participant "ParallelCoordinator" as Coord
participant "BusinessMonitor" as Monitor
participant "BackupService" as Svc
participant "LargeFileThrottle" as Throttle
participant "EncryptionService" as Crypto
participant "CompositeLogger" as Log

User -> VM : Click "Execute All Jobs"
activate VM

VM -> Coord : ExecuteJobsInParallelAsync(jobs)
activate Coord

Coord -> Monitor : StartMonitoring()
activate Monitor
Monitor --> Coord : Monitoring Active
deactivate Monitor

par For Each Job (Parallel Task)
    Coord -> Coord : Create JobExecutionContext
    
    Coord -> Svc : ExecuteBackupWithContext(job, context)
    activate Svc
    
    Svc -> Svc : Scan Files
    
    loop For Each File
        ' Business Logic Check
        alt Business Software Detected
            Monitor -> Coord : Raise SoftwareStarted
            Coord -> Coord : PauseAllJobs()
            Coord -> Svc : Pause() via Context
            Svc -> Svc : Wait(PauseEvent)
            
            ... Software Closes ...
            
            Monitor -> Coord : Raise SoftwareStopped
            Coord -> Coord : ResumeAllJobs()
            Coord -> Svc : Resume() via Context
            Svc -> Svc : Continue
        end
        
        ' Priority Handling
        Svc -> Svc : Check Priority Files
        note right: If non-priority file,\nwait for priority queues to clear
        
        ' Large File Throttling
        alt File Size > Limit
            Svc -> Throttle : WaitAsync()
            activate Throttle
            Throttle --> Svc : Grant Access
            deactivate Throttle
        end
        
        ' Process File
        alt Should Encrypt
            Svc -> Crypto : EncryptFile()
            activate Crypto
            Crypto -> Crypto : Mutex.WaitOne()
            Crypto -> "CryptoSoft.exe" : Process.Start()
            "CryptoSoft.exe" --> Crypto : Exit
            Crypto -> Crypto : Mutex.Release()
            Crypto --> Svc : Done
            deactivate Crypto
        else
            Svc -> Svc : File.Copy()
        end
        
        ' Release Throttle
        alt File Size > Limit
            Svc -> Throttle : Release()
        end
        
        Svc -> Log : WriteLog(entry)
        activate Log
        Log -> "File.json" : Write()
        Log -> "Docker(TCP)" : Send()
        deactivate Log
        
    end
    
    Svc --> Coord : Job Complete
    deactivate Svc
end

Coord -> Monitor : StopMonitoring()
Coord --> VM : All Jobs Complete
deactivate Coord

VM --> User : Update UI "Completed"
deactivate VM

@enduml
