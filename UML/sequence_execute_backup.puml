@startuml EasySave_Sequence_Execute_Backup_v2.0
!theme plain
autonumber

actor User
participant "Program" as Prog
participant "JobManager" as JM
participant "BackupService" as BS
participant "BusinessSoftwareDetector" as BSD
participant "EncryptionService" as ES
participant "PathHelper" as PH
participant "ILogger" as Log
participant "FileSystem" as FS

User -> Prog : Run backup (job index)
activate Prog

Prog -> JM : GetJob(index)
activate JM
JM --> Prog : BackupJob
deactivate JM

Prog -> BS : ExecuteBackup(job, businessSoftwareName)
activate BS

' v2.0: Business software check
alt Business software configured
    BS -> BSD : IsAnyRunning(softwareList)
    activate BSD
    BSD --> BS : isRunning
    deactivate BSD
    
    alt Business software is running
        BS --> Prog : throw Exception("Business software active")
        Prog --> User : Display error message
        deactivate BS
        deactivate Prog
        stop
    end
end

' Calculate total files and size
BS -> BS : CalculateTotalFilesAndSize(sourcePath)
activate BS
BS -> FS : GetFiles(sourceDir)
activate FS
FS --> BS : files[]
deactivate FS
BS -> FS : GetDirectories(sourceDir)
activate FS
FS --> BS : subdirs[]
deactivate FS
BS --> BS : (totalFiles, totalSize)
deactivate BS

' Initialize state
BS -> Log : UpdateState(ACTIVE, 0%)
activate Log
Log -> FS : WriteAllText(state.json/xml)
activate FS
deactivate FS
deactivate Log

' Process directory
BS -> BS : ProcessDirectory(source, target, job)
activate BS

loop For each file in directory
    ' Update state before copying
    BS -> Log : UpdateState(ACTIVE, progress%)
    activate Log
    Log -> FS : WriteAllText(state.json/xml)
    deactivate Log
    
    alt Full backup OR (Differential AND source newer)
        BS -> BS : Start timer
        
        ' v2.0: Encryption logic
        alt File extension in priority list
            ' Copy to temporary file
            BS -> FS : Copy to temp file
            activate FS
            FS --> BS : tempFilePath
            deactivate FS
            
            ' Encrypt file
            BS -> ES : EncryptFile(tempFile, targetFile)
            activate ES
            note right
                v2.0: Calls CryptoSoft.exe
            end note
            ES --> BS : encryptionTime (ms)
            deactivate ES
            
            ' Delete temporary file
            BS -> FS : Delete(tempFile)
            activate FS
            deactivate FS
            
        else Direct copy (no encryption)
            ' Copy file directly
            BS -> FS : OpenRead(sourceFile)
            activate FS
            FS --> BS : sourceStream
            deactivate FS
            
            BS -> FS : Create(targetFile)
            activate FS
            FS --> BS : targetStream
            deactivate FS
            
            BS -> FS : CopyTo(targetStream)
        end
        
        BS -> BS : Stop timer
        
        ' Convert to UNC format
        BS -> PH : ToUncPath(sourcePath)
        activate PH
        PH --> BS : uncSourcePath
        deactivate PH
        
        BS -> PH : ToUncPath(targetPath)
        activate PH
        PH --> BS : uncTargetPath
        deactivate PH
        
        ' Log success (v2.0: includes EncryptionTime)
        BS -> Log : WriteLog(logEntry with EncryptionTime)
        activate Log
        note right
            v2.0: LogEntry now includes
            EncryptionTime field
            Format: JSON or XML (v1.1)
        end note
        Log -> FS : AppendAllText(YYYY-MM-DD.json/xml)
        activate FS
        deactivate FS
        deactivate Log
    end
end

' Process subdirectories recursively
loop For each subdirectory
    BS -> BS : ProcessDirectory(subDir, targetSubDir, job)
end

deactivate BS

' Mark as completed
BS -> Log : UpdateState(END, 100%)
activate Log
Log -> FS : WriteAllText(state.json/xml)
deactivate Log

BS --> Prog : backup completed
deactivate BS

Prog --> User : Display success message
deactivate Prog

@enduml
