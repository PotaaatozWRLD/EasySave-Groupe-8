@startuml EasySave_Sequence_Execute_Backup_v2.0
!theme plain
autonumber

actor User
participant "MainViewModel" as VM
participant "BackupService" as BS
participant "BusinessSoftwareDetector" as BSD
participant "EncryptionService" as ES
participant "ILogger" as Log
participant "CryptoSoft" as CS

User -> VM : Click "Execute Job"
activate VM

VM -> VM : Initialize BackupService
note right
    Injects Logger, CryptoSoftPath,
    ExtensionsToEncrypt
end note

VM -> BS : ExecuteBackup(job, businessSoftwareName)
activate BS

' Business Software Check
alt Business software configured
    BS -> BSD : IsAnyRunning(businessSoftwarelist)
    activate BSD
    BSD --> BS : result (bool)
    deactivate BSD
    
    break result is true
        BS --> VM : throw InvalidOperationException
        VM --> User : Show Error "Software Running"
        deactivate BS
        deactivate VM
    end
end

' Start Backup
BS -> Log : UpdateState(ACTIVE, 0%)
activate Log
deactivate Log

BS -> BS : ProcessDirectory(source, target)
activate BS

loop For each file
    BS -> Log : UpdateState(ACTIVE, progress)
    activate Log
    deactivate Log

    alt Full Backup OR (Differential AND New/Modified)
        
        ' Check Encryption
        BS -> ES : ShouldEncrypt(file, extensions)
        activate ES
        ES --> BS : shouldEncrypt
        deactivate ES
        
        alt shouldEncrypt is true
            BS -> ES : EncryptFile(source, target)
            activate ES
            ES -> CS : Process.Start(CryptoSoft.exe)
            activate CS
            CS --> ES : Exit Code 0
            deactivate CS
            ES --> BS : encryptionTime
            deactivate ES
        else
            BS -> BS : File.Copy(source, target)
        end
        
        BS -> Log : WriteLog(entry)
        activate Log
        note right
             Entry includes:
             - TransferTime
             - EncryptionTime
             - Status
        end note
        deactivate Log
        
    end
end

deactivate BS

BS -> Log : UpdateState(END, 100%)
activate Log
deactivate Log

BS --> VM : Complete
deactivate BS

VM --> User : Show Success Message
deactivate VM

@enduml
