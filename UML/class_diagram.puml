@startuml EasySave_Class_Diagram_v2.0
!theme plain
skinparam classAttributeIconSize 0

' =============== CONSOLE LAYER ===============
package "EasySave.Console" {
    class Program {
        - {static} _lang : LanguageManager
        + {static} Main(args : string[]) : void
        - {static} ShowLanguageSelectionMenu() : void
        - {static} ChangeLanguage() : void
        - {static} ListJobs() : void
        - {static} CreateJob() : void
        - {static} EditJob() : void
        - {static} DeleteJob() : void
        - {static} RunJob(backupService : BackupService) : void
        - {static} RunAllJobs(backupService : BackupService) : void
        - {static} ParseJobIndexes(input : string) : IEnumerable<int>
    }

    class LanguageManager {
        - {static} _instance : LanguageManager
        - {static} _lock : object
        - _strings : Dictionary<string, string>
        - _currentLanguage : string
        - LanguageManager()
        + {static} Instance : LanguageManager <<get>>
        + CurrentLanguage : string <<get>>
        - LoadLanguage(culture : string) : void
        + GetString(key : string) : string
        + ChangeLanguage(culture : string) : void
        + ToggleLanguage() : void
    }

    class AppConfig {
        - {static} ConfigFilePath : string
        - {static} _config : AppConfig
        - {static} _configPath : string
        + Language : string
        + LogFormatString : string
        + ExtensionsToEncrypt : List<string>
        + BusinessSoftwareNames : List<string>
        + CryptoSoftPath : string
        - {static} Load() : void
        - {static} Save() : void
        + {static} GetLanguage() : string
        + {static} HasLanguageConfigured() : bool
        + {static} SetLanguage(language : string) : void
        + {static} GetLogFormat() : LogFormat
        + {static} SetLogFormat(format : LogFormat) : void
        + {static} GetExtensionsToEncrypt() : List<string>
        + {static} SetExtensionsToEncrypt(extensions : List<string>) : void
        + {static} GetBusinessSoftwareNames() : List<string>
        + {static} SetBusinessSoftwareNames(processNames : List<string>) : void
        + {static} GetCryptoSoftPath() : string
        + {static} SetCryptoSoftPath(path : string) : void
    }
}

' =============== GUI LAYER (v2.0) ===============
package "EasySave.GUI" {
    class MainViewModel {
        - _jobs : ObservableCollection<BackupJob>
        - _logger : ILogger
        + CreateJob() : void
        + ExecuteJob(job : BackupJob) : void
        + DeleteJob(job : BackupJob) : void
    }
    
    class JobEditorViewModel {
        + Job : BackupJob
        + SaveCommand : ICommand
        + CancelCommand : ICommand
    }
    
    class LocalizationManager {
        - {static} _instance : LocalizationManager
        - _resourceManager : ResourceManager
        - _currentCulture : CultureInfo
        - LocalizationManager()
        + {static} Instance : LocalizationManager <<get>>
        + CurrentCulture : string <<get>>
        + this[key : string] : string <<get>>
        + ChangeLanguage(culture : string) : void
        + ToggleLanguage() : void
    }
}

' =============== CORE LAYER ===============
package "EasySave.Core" {
    package "Models" {
        enum BackupType {
            Full
            Differential
        }

        class BackupJob {
            + Name : string
            + SourcePath : string
            + TargetPath : string
            + Type : BackupType
            + CreatedDate : DateTime?
            + LastExecutionDate : DateTime?
            + Description : string?
            + BackupJob(name, sourcePath, targetPath, type)
        }
    }

    package "Services" {
        class JobManager {
            - {static} JobsFilePath : string
            + {static} Jobs : List<BackupJob>
            + {static} LoadJobs() : void
            + {static} SaveJobs() : void
            + {static} AddJob(name, source, target, type) : void
            + {static} DeleteJob(index : int) : void
            + {static} GetJob(index : int) : BackupJob
        }
        
        note right of JobManager
            v2.0: Unlimited jobs
            (v1.0/v1.1: max 5 jobs)
        end note

        class BackupService {
            - _logger : ILogger
            - _encryptionService : EncryptionService?
            - _extensionsToEncrypt : List<string>
            + BackupService(logger : ILogger)
            + BackupService(logger : ILogger, cryptoSoftPath : string, extensionsToEncrypt : List<string>)
            + ExecuteBackup(job : BackupJob) : void
            + ExecuteBackup(job : BackupJob, businessSoftwareName : string) : void
            - CalculateTotalFilesAndSize(sourceDir : string) : (int, long)
            - ProcessDirectory(sourceDir, targetDir, job, filesProcessed, bytesProcessed, totalFiles, totalSize) : void
            - IsSourceNewer(sourceFile, targetFile) : bool
        }
        
        class EncryptionService {
            - _cryptoSoftPath : string
            + EncryptionService(cryptoSoftPath : string)
            + EncryptFile(sourceFile : string, targetFile : string) : long
            + {static} ShouldEncrypt(filePath : string, extensions : List<string>) : bool
        }
        
        class BusinessSoftwareDetector <<static>> {
            + {static} IsAnyRunning(processNames : List<string>) : bool
            + {static} IsRunning(processName : string) : bool
        }
    }

    package "Helpers" {
        class PathHelper <<static>> {
            + {static} ToUncPath(path : string) : string
        }
    }
}

' =============== EASYLOG DLL ===============
package "EasyLog" {
    interface ILogger {
        + WriteLog(logEntry : LogEntry) : void
        + UpdateState(stateEntry : StateEntry) : void
    }

    class JsonLogger {
        - _logDirectory : string
        - _stateFilePath : string
        + JsonLogger(logDirectory, stateFilePath)
        + WriteLog(logEntry : LogEntry) : void
        + UpdateState(stateEntry : StateEntry) : void
    }
    
    class XmlLogger {
        - _logDirectory : string
        - _stateFilePath : string
        + XmlLogger(logDirectory, stateFilePath)
        + WriteLog(logEntry : LogEntry) : void
        + UpdateState(stateEntry : StateEntry) : void
    }
    
    class LoggerFactory <<static>> {
        + {static} CreateLogger(format : LogFormat, logDirectory : string, stateFilePath : string) : ILogger
    }
    
    enum LogFormat {
        JSON
        XML
    }

    class LogEntry {
        + JobName : string
        + SourcePath : string
        + TargetPath : string
        + FileName : string
        + FileSize : long
        + TransferTime : long
        + EncryptionTime : long
        + ErrorMessage : string?
        + Timestamp : DateTime
    }

    class StateEntry {
        + Name : string
        + LastActionTimestamp : string
        + State : JobState
        + TotalFiles : int
        + TotalSize : long
        + Progression : int
        + NbFilesLeftToDo : int
        + NbFilesLeftToDoSize : long
        + CurrentSourceFilePath : string
        + CurrentTargetFilePath : string
    }

    enum JobState {
        ACTIVE
        END
        PAUSED
    }
}

' =============== RELATIONSHIPS ===============
Program --> LanguageManager : uses
Program --> AppConfig : uses
Program --> JobManager : uses
Program --> BackupService : creates

LanguageManager --> AppConfig : uses

' GUI relationships (v2.0)
MainViewModel --> BackupService : uses
MainViewModel --> JobManager : uses
MainViewModel --> ILogger : uses
MainViewModel --> BackupJob : manages
JobEditorViewModel --> BackupJob : edits
LocalizationManager --> AppConfig : uses

' Core services relationships (v2.0)
BackupService --> ILogger : depends on
BackupService --> BackupJob : uses
BackupService --> PathHelper : uses
BackupService --> LogEntry : creates
BackupService --> StateEntry : creates
BackupService --> EncryptionService : uses
BackupService --> BusinessSoftwareDetector : uses

EncryptionService ..> BackupService : used by

JobManager --> BackupJob : manages
JobManager ..> BackupType : uses

BackupJob --> BackupType : has

' Logger relationships (v2.0)
LoggerFactory ..> JsonLogger : creates
LoggerFactory ..> XmlLogger : creates
LoggerFactory ..> LogFormat : uses
AppConfig --> LogFormat : contains

JsonLogger ..|> ILogger : implements
JsonLogger --> LogEntry : uses
JsonLogger --> StateEntry : uses

XmlLogger ..|> ILogger : implements
XmlLogger --> LogEntry : uses
XmlLogger --> StateEntry : uses

StateEntry --> JobState : has

note right of JobManager
  v2.0: Unlimited jobs
  (v1.0/v1.1: max 5)
  Saves to %AppData%\ProSoft\EasySave\jobs.json
end note

note right of BackupService
  Supports Full and Differential backups
  Calculates progress in real-time
  Converts paths to UNC format
  v2.0: Encryption & business software check
end note

note right of JsonLogger
  Writes daily logs: YYYY-MM-DD.json
  Updates state.json in real-time
  Located in %AppData%\ProSoft\EasySave\
end note

note right of XmlLogger
  v1.1: Alternative to JSON format
  Same structure as JsonLogger
  User-selectable format
end note

note right of LanguageManager
  Singleton pattern
  Supports EN and FR
end note

note right of LocalizationManager
  v2.0: GUI-specific localization
  Singleton pattern (like LanguageManager)
end note

note right of EncryptionService
  v2.0: Calls CryptoSoft.exe
  for priority file extensions
  (.docx, .xlsx, etc.)
end note

note right of BusinessSoftwareDetector
  v2.0: Prevents backups when
  configured software is running
end note

note right of MainViewModel
  v2.0: WPF/Avalonia GUI
  MVVM pattern
  ObservableCollection for live updates
end note

@enduml
