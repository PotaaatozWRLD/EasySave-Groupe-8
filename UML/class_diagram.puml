@startuml EasySave_Class_Diagram_v2.0
!theme plain
skinparam classAttributeIconSize 0

' =============== CONSOLE LAYER ===============
package "EasySave.Console" {
    class Program {
        + {static} Main(args : string[]) : void
        - {static} ShowLanguageSelectionMenu() : void
        - {static} ChangeLanguage() : void
        - {static} DisplayMenu() : void
        - {static} ListJobs() : void
        - {static} CreateJob() : void
        - {static} EditJob() : void
        - {static} DeleteJob() : void
        - {static} ExecuteJob() : void
        - {static} ExecuteAllJobs() : void
        - {static} ParseJobIndexes(input : string) : List<int>
    }

    class AppConfig {
        + {static} Language : string
        + {static} LogFormat : LogFormat
        + {static} ExtensionsToEncrypt : List<string>
        + {static} BusinessSoftwareNames : List<string>
        + {static} CryptoSoftPath : string
        + {static} Save() : void
        + {static} Load() : void
    }

    class LanguageManager {
        + {static} Instance : LanguageManager
        + CurrentLanguage : string
        + GetString(key : string) : string
        + ChangeLanguage(cultureCode : string) : void
    }
}

' =============== GUI LAYER (v2.0) ===============
package "EasySave.GUI" {
    class MainViewModel {
        - _jobs : ObservableCollection<BackupJob>
        - _selectedJobs : ObservableCollection<BackupJob>
        - _selectedJob : BackupJob?
        - _statusMessage : string
        - _isExecuting : bool
        - _logger : ILogger?
        + CreateJob() : void
        + EditJob() : void
        + DeleteJob() : void
        + ExecuteSelectedJobAsync() : Task
        + ExecuteAllJobsAsync() : Task
        + OpenSettings() : void
        + SwitchLanguage() : void
        + OpenLogsFolder() : void
        + DecryptFileAsync() : Task
        + Exit() : void
    }
    
    class JobEditorViewModel {
        + Job : BackupJob
        + Name : string
        + SourcePath : string
        + TargetPath : string
        + Type : BackupType
        + CreateJob() : BackupJob
    }
    
    class SettingsViewModel {
        + Language : string
        + LogFormat : LogFormat
        + CryptoSoftPath : string
        + ExtensionsToEncrypt : string
        + BusinessSoftwareNames : string
        + Save() : void
    }
    
    class LocalizationManager {
        + {static} Instance : LocalizationManager
        + CurrentCulture : CultureInfo
        + this[key] : string
        + ToggleLanguage() : void
    }
}

' =============== CORE LAYER ===============
package "EasySave.Core" {
    package "Models" {
        enum BackupType {
            Full
            Differential
        }

        class BackupJob {
            + Name : string
            + SourcePath : string
            + TargetPath : string
            + Type : BackupType
            + CreatedDate : DateTime?
            + LastExecutionDate : DateTime?
            + Description : string?
            + BackupJob(name, sourcePath, targetPath, type)
        }
    }

    package "Services" {
        class JobManager {
            + {static} Jobs : List<BackupJob>
            + {static} LoadJobs() : void
            + {static} SaveJobs() : void
            + {static} AddJob(name, source, target, type) : void
            + {static} DeleteJob(index : int) : void
            + {static} GetJob(index : int) : BackupJob
        }

        class BackupService {
            - _logger : ILogger
            - _encryptionService : EncryptionService?
            - _extensionsToEncrypt : List<string>
            + BackupService(logger : ILogger)
            + BackupService(logger : ILogger, cryptoSoftPath : string, extensionsToEncrypt : List<string>)
            + ExecuteBackup(job : BackupJob, businessSoftwareName : string?) : void
            - CalculateTotalFilesAndSize(sourceDir : string) : (int, long)
            - ProcessDirectory(sourceDir, targetDir, job, filesProcessed, bytesProcessed, totalFiles, totalSize) : void
        }
        
        class EncryptionService {
            - _cryptoSoftPath : string
            - _timeoutMilliseconds : int
            + EncryptionService(cryptoSoftPath : string, timeoutMilliseconds : int)
            + EncryptFile(sourceFile : string, targetFile : string) : long
            + {static} ShouldEncrypt(filePath : string, extensions : List<string>) : bool
        }
        
        class BusinessSoftwareDetector <<static>> {
            + {static} IsAnyRunning(processNames : IEnumerable<string>) : bool
            + {static} IsRunning(processName : string) : bool
        }
    }
    
    package "Helpers" {
        class PathHelper <<static>> {
            + {static} ToUncPath(path : string) : string
        }
    }
}

' =============== EASYLOG DLL ===============
package "EasyLog" {
    interface ILogger {
        + WriteLog(logEntry : LogEntry) : void
        + UpdateState(stateEntry : StateEntry) : void
    }

    class JsonLogger {
        - _logDirectory : string
        - _stateFilePath : string
        + JsonLogger(logDirectory : string, stateFilePath : string)
        + WriteLog(logEntry : LogEntry) : void
        + UpdateState(stateEntry : StateEntry) : void
    }
    
    class XmlLogger {
        - _logDirectory : string
        - _stateFilePath : string
        + XmlLogger(logDirectory : string, stateFilePath : string)
        + WriteLog(logEntry : LogEntry) : void
        + UpdateState(stateEntry : StateEntry) : void
    }
    
    class LoggerFactory <<static>> {
        + {static} CreateLogger(format : LogFormat, logDirectory : string, stateFilePath : string) : ILogger
    }
    
    enum LogFormat {
        JSON
        XML
    }

    class LogEntry {
        + JobName : string
        + SourcePath : string
        + TargetPath : string
        + FileName : string
        + FileSize : long
        + TransferTime : long
        + EncryptionTime : long
        + ErrorMessage : string?
        + Timestamp : DateTime
    }

    class StateEntry {
        + Name : string
        + LastActionTimestamp : string
        + State : JobState
        + TotalFiles : int
        + TotalSize : long
        + Progression : int
        + NbFilesLeftToDo : int
        + NbFilesLeftToDoSize : long
        + CurrentSourceFilePath : string
        + CurrentTargetFilePath : string
    }

    enum JobState {
        ACTIVE
        END
        PAUSED
    }
}

' =============== CRYPTOSOFT ===============
package "CryptoSoft" {
    class Program {
        + {static} Main(args : string[]) : int
        - {static} XorEncrypt(data : byte[], key : string) : byte[]
    }
}

' =============== RELATIONSHIPS ===============

' Console
Program ..> JobManager : uses
Program ..> BackupService : creates
Program ..> AppConfig : uses
Program ..> LanguageManager : uses
Program ..> BackupType : uses

' GUI
MainViewModel --> JobManager : uses
MainViewModel --> BackupService : creates
MainViewModel --> ILogger : uses
MainViewModel --> LocalizationManager : uses
MainViewModel ..> AppConfig : uses
MainViewModel --> BackupJob : manages
JobEditorViewModel --> BackupJob : creates/edits
SettingsViewModel ..> AppConfig : modifies
SettingsViewModel ..> LanguageManager : uses

' Core
JobManager --> BackupJob : manages
BackupService --> ILogger : uses
BackupService --> EncryptionService : uses
BackupService --> BusinessSoftwareDetector : uses
BackupService ..> PathHelper : uses
BackupService ..> LogEntry : creates
BackupService ..> StateEntry : creates
EncryptionService ..> Program : executes (Process.Start)

' Log
JsonLogger ..|> ILogger
XmlLogger ..|> ILogger
LoggerFactory ..> ILogger : creates
LoggerFactory ..> JsonLogger : creates
LoggerFactory ..> XmlLogger : creates
LoggerFactory ..> LogFormat : uses

' Models
BackupJob --> BackupType : has

@enduml
