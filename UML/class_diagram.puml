@startuml EasySave_Class_Diagram_v3.0
!theme plain
skinparam classAttributeIconSize 0

' =============== CONSOLE LAYER ===============
package "EasySave.Console" {
    class Program {
        + {static} Main(args : string[]) : void
    }

    class AppConfig {
        + {static} Language : string
        + {static} LogFormat : LogFormat
        + {static} ExtensionsToEncrypt : List<string>
        + {static} BusinessSoftwareNames : List<string>
        + {static} CryptoSoftPath : string
        + {static} PriorityExtensions : List<string>
        + {static} MaxLargeFileSizeKB : long
        + {static} LoggingMode : string
        + {static} LogServerIp : string
        + {static} LogServerPort : int
        + {static} Save() : void
        + {static} Load() : void
    }

    class LanguageManager {
        + {static} Instance : LanguageManager
        + CurrentLanguage : string
        + GetString(key : string) : string
    }
}

' =============== GUI LAYER (v2.0/v3.0) ===============
package "EasySave.GUI" {
    class MainViewModel {
        - _jobs : ObservableCollection<BackupJob>
        - _coordinator : ParallelBackupCoordinator?
        - _logger : ILogger?
        + ExecuteSelectedJobCommand : ICommand
        + ExecuteAllJobsCommand : ICommand
        + PauseJobCommand : ICommand
        + ResumeJobCommand : ICommand
        + StopJobCommand : ICommand
        + PauseAllCommand : ICommand
        + ResumeAllCommand : ICommand
        + StopAllCommand : ICommand
        + ExecuteSelectedJobAsync() : Task
        + ExecuteAllJobsAsync() : Task
        - InitializeServices() : void
    }

    class SettingsViewModel {
        + SelectedLoggingMode : string
        + LogServerIp : string
        + LogServerPort : int
        + LoggingModes : ObservableCollection<string>
        + SaveCommand : ICommand
    }
    
    class LocalizationManager {
        + {static} Instance : LocalizationManager
        + this[key] : string
    }
}

' =============== CORE LAYER ===============
package "EasySave.Core" {
    package "Models" {
        enum BackupType {
            Full
            Differential
        }

        class BackupJob {
            + Name : string
            + SourcePath : string
            + TargetPath : string
            + Type : BackupType
        }
        
        class JobExecutionContext {
            + Job : BackupJob
            + State : JobExecutionState
            + PauseEvent : ManualResetEventSlim
            + CancellationTokenSource : CancellationTokenSource
            + CheckPauseAndCancellation() : void
            + Pause() : void
            + Resume() : void
            + Stop() : void
        }
    }

    package "Services" {
        class JobManager {
            + {static} Jobs : List<BackupJob>
            + {static} SaveJobs() : void
        }

        class ParallelBackupCoordinator {
            - _logger : ILogger
            - _contexts : ConcurrentDictionary<string, JobExecutionContext>
            - _monitor : BusinessSoftwareMonitor
            + ExecuteJobsInParallelAsync(...) : Task
            + PauseJob(jobName) : void
            + ResumeJob(jobName) : void
            + StopJob(jobName) : void
        }

        class BusinessSoftwareMonitor {
            + event SoftwareStarted : EventHandler
            + event SoftwareStopped : EventHandler
            + StartMonitoring() : void
            + StopMonitoring() : void
        }

        class LargeFileThrottle {
             - _semaphore : SemaphoreSlim
             + WaitAsync() : Task
             + Release() : void
        }

        class BackupService {
            - _logger : ILogger
            - _encryptionService : EncryptionService?
            - _largeFileThrottle : LargeFileThrottle?
            + ExecuteBackupWithContext(...) : void
            - ProcessDirectory(...) : void
        }
        
        class EncryptionService {
            - _semaphore : SemaphoreSlim
            + EncryptFile(...) : long
        }
    }
}

' =============== EASYLOG DLL ===============
package "EasyLog" {
    interface ILogger {
        + WriteLog(logEntry : LogEntry) : void
        + UpdateState(stateEntry : StateEntry) : void
    }

    class JsonLogger {
        + WriteLog() : void
    }
    
    class XmlLogger {
        + WriteLog() : void
    }

    class NetworkLogger {
        - _client : TcpClient
        + WriteLog() : void
        + UpdateState() : void
    }

    class CompositeLogger {
        - _loggers : List<ILogger>
        + WriteLog() : void
        + UpdateState() : void
    }
    
    class LogEntry {
        + JobName : string
        + MachineName : string
        + UserName : string
        + TransferTime : long
        + EncryptionTime : long
    }
}

' =============== RELATIONSHIPS ===============

MainViewModel --> ParallelBackupCoordinator : Uses
MainViewModel --> AppConfig : Configures
SettingsViewModel --> AppConfig : Reads/Writes
ParallelBackupCoordinator --> BackupService : Delegates
ParallelBackupCoordinator --> BusinessSoftwareMonitor : Subscribes
ParallelBackupCoordinator --> JobExecutionContext : Manages
BackupService --> LargeFileThrottle : Uses
BackupService --> EncryptionService : Uses
BackupService --> ILogger : Logs to
LogEntry --* ILogger : Data

CompositeLogger ..|> ILogger
NetworkLogger ..|> ILogger
JsonLogger ..|> ILogger
XmlLogger ..|> ILogger
CompositeLogger o-- ILogger : Aggregates

@enduml
